[phases.setup]
aptPkgs = [
  "gdal-bin",
  "libgdal-dev",
  "libgdal34",
  "binutils",
  "libproj-dev",
  "proj-data",
  "libgeos-dev",
  "geos",
  "postgresql-client",
  "libpq-dev",
  "python3-dev",
  "build-essential"
]

[variables]
PIP_NO_CACHE_DIR = "1"
PIP_PREFER_BINARY = "1"

[phases.install]
cmds = [
  "echo '=== Installing Python Dependencies ==='",
  "pip install --upgrade pip setuptools wheel --no-cache-dir",
  "echo 'Creating temporary requirements file without GDAL...'",
  "grep -v '^GDAL' requirements.txt > /tmp/requirements_no_gdal.txt || cp requirements.txt /tmp/requirements_no_gdal.txt",
  "echo 'Installing requirements (excluding GDAL - will install separately)...'",
  "pip install --prefer-binary --no-cache-dir --timeout=300 -r /tmp/requirements_no_gdal.txt || echo 'WARNING: Some packages failed to install - check logs above'",
  "echo 'Attempting to install GDAL Python package (optional - GeoDjango works with system libraries)...'",
  "pip install --prefer-binary --no-cache-dir --timeout=600 'GDAL>=3.4.0,<4.0.0' || echo 'INFO: GDAL Python package installation skipped or timed out (GeoDjango will use system libraries - this is OK)'",
  "echo 'Verifying critical packages...'",
  "python -c 'import django; print(\"✓ Django:\", django.__version__)' 2>&1 || echo '✗ ERROR: Django not installed'",
  "python -c 'import torch; print(\"✓ PyTorch:\", torch.__version__)' 2>&1 || echo '⚠ WARNING: PyTorch not installed'",
  "python -c 'import gdal; print(\"✓ GDAL Python package:\", gdal.__version__)' 2>&1 || python -c 'from osgeo import gdal; print(\"✓ GDAL Python package:\", gdal.__version__)' 2>&1 || echo 'ℹ INFO: GDAL Python package not available (GeoDjango will use system libraries - this is OK)'"
]

[phases.build]
cmds = [
  "echo '=== Starting GeoDjango/GDAL Validation ==='",
  "echo 'Checking system GDAL installation...'",
  "gdal-config --version || echo 'ERROR: gdal-config not found'",
  "echo 'Checking system GEOS installation...'",
  "geos-config --version || echo 'ERROR: geos-config not found'",
  "echo 'Checking system PROJ installation...'",
  "proj --version || echo 'ERROR: proj not found'",
  "echo 'Validating Django configuration...'",
  "DJANGO_SETTINGS_MODULE=config.settings python manage.py check --deploy 2>&1 || echo 'WARNING: Django check completed with warnings'",
  "echo 'Testing GEOS import...'",
  "DJANGO_SETTINGS_MODULE=config.settings python -c 'from django.contrib.gis import geos; print(\"✓ GEOS version:\", geos.geos_version)' 2>&1 || echo '✗ ERROR: GEOS import failed'",
  "echo 'Testing GDAL import...'",
  "DJANGO_SETTINGS_MODULE=config.settings python -c 'from django.contrib.gis import gdal; print(\"✓ GDAL version:\", gdal.gdal_version)' 2>&1 || echo '✗ ERROR: GDAL import failed'",
  "echo 'Testing PROJ import...'",
  "DJANGO_SETTINGS_MODULE=config.settings python -c 'from django.contrib.gis import gdal; print(\"✓ PROJ version:\", gdal.proj_version)' 2>&1 || echo '✗ ERROR: PROJ import failed'",
  "echo 'Testing GeoDjango models import...'",
  "DJANGO_SETTINGS_MODULE=config.settings python -c 'import os; os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"config.settings\"); import django; django.setup(); from django.contrib.gis.db import models; print(\"✓ GeoDjango models imported successfully\")' 2>&1 || echo '✗ ERROR: GeoDjango models import failed'",
  "echo 'Testing PostGIS backend...'",
  "DJANGO_SETTINGS_MODULE=config.settings python -c 'import os; os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"config.settings\"); import django; django.setup(); from django.contrib.gis.db.backends.postgis import base; print(\"✓ PostGIS backend available\")' 2>&1 || echo '✗ ERROR: PostGIS backend not available'",
  "echo '=== GeoDjango/GDAL Validation Complete ==='"
]
